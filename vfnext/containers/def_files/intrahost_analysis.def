Bootstrap: library
From: debian:11

%environment
    export PATH=$PATH:/usr/local/bin/micromamba:/usr/local/bin/mm:/usr/local/bin/mm/bin:/usr/local/bam-readcount/build/bin/
    
%post
    DEBIAN_FRONTEND=noninteractive
    apt-get update -qq -y && apt install -y bzip2 curl git build-essential manpages-dev cmake
    cd /usr/local
    rmdir bin
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
    export MAMBA_ROOT_PREFIX=/usr/local/bin/mm
    eval "$(/usr/local/bin/micromamba shell hook -s posix)"
    /usr/local/bin/micromamba shell init -s bash -r /usr/local/bin/mm
    micromamba shell init --shell=bash --root-prefix=/usr/local/bin/mm
    micromamba activate
    micromamba config append channels conda-forge --env
    micromamba self-update
    micromamba install -c conda-forge python==3.8 procps-ng biopython==1.81 pandas==1.5.3 numpy==1.23
    git clone https://github.com/genome/bam-readcount 
    cd bam-readcount
    mkdir build
    cd build
    cmake ..
    make

    # Clean apt cache + docs
    apt-get clean
    micromamba clean --all --yes
    rm -rf /var/lib/apt/lists/* /usr/share/man /usr/share/doc /usr/share/locale
