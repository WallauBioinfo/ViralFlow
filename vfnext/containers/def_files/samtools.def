Bootstrap: docker
From: debian:11-slim

%environment
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH=/opt/conda/bin:/usr/local/bin:$PATH

%post
    set -eux
    
    export MAMBA_ROOT_PREFIX=/opt/conda

    apt-get update
    apt-get install -y --no-install-recommends \
        curl \
        bzip2 \
        ca-certificates

    # Install micromamba (static binary)
    mkdir -p /usr/local/bin
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest \
        | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba

    # Install packages
    micromamba install -y -n base -c conda-forge -c bioconda \
        samtools=1.11 \
        python=3.10

    # Aggressive cleanup
    micromamba clean --all --yes
    find /opt/conda -name "*.a" -delete
    find /opt/conda -name "*.pyc" -delete
    find /opt/conda -type d -name "__pycache__" -exec rm -rf {} +

    # Remove build deps + docs
    apt-get purge -y curl bzip2
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/* /usr/share/man /usr/share/doc /usr/share/locale
